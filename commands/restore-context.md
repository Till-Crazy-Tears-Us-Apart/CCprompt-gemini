---
description: "从 .compact_args.md 文件中恢复会话上下文，并等待下一步指令。"
allowed-tools: Bash, Read, Grep, Glob
argument-hint: ""
---

你的任务是作为会话上下文的“反序列化器”，严格遵循以下四步工作流，从项目根目录下的 `.compact_args.md` 文件中恢复一个完整的、可验证的工作状态。

---

### **工作流 (Workflow)**

**【第一步：前置条件验证 (Pre-condition Verification)】**

你**必须**首先执行以下 Bash 脚本。该脚本会原子化地完成对 `.compact_args.md` 文件的**存在性**和**内容格式**的双重验证。

-   **如果验证失败**: 脚本会输出明确的错误信息并以失败状态退出。在这种情况下，你的任务即告失败，**必须**将该错误信息报告给用户，并立即终止所有后续操作。
-   **如果验证成功**: 脚本会静默地以成功状态退出。你才能继续执行下一步。

```bash
#!/bin/bash

# 定义文件路径
COMPACT_FILE=".compact_args.md"

# 1. 存在性检查
if [ ! -f "$COMPACT_FILE" ]; then
    echo "错误：在项目根目录下未找到 '$COMPACT_FILE' 文件。请先在之前的会话中运行 /prepare-compact。" >&2
    exit 1
fi

# 2. 格式指纹验证 (检查所有核心标题是否存在)
# 使用 grep -q 来静默检查
grep -q "**1. 核心任务与当前状态**" "$COMPACT_FILE" || { echo "错误：'$COMPACT_FILE' 文件格式不完整，缺少“核心任务与当前状态”章节。" >&2; exit 1; }
grep -q "**2. 文件状态快照 (自动生成)**" "$COMPACT_FILE" || { echo "错误：'$COMPACT_FILE' 文件格式不完整，缺少“文件状态快照”章节。" >&2; exit 1; }
grep -q "**3. 下一轮对话记忆恢复协议**" "$COMPACT_FILE" || { echo "错误：'$COMPACT_FILE' 文件格式不完整，缺少“记忆恢复协议”章节。" >&2; exit 1; }
grep -q "**4. 必须保留的技术细节与方案**" "$COMPACT_FILE" || { echo "错误：'$COMPACT_FILE' 文件格式不完整，缺少“技术细节与方案”章节。" >&2; exit 1; }
grep -q "**5. 后续行动协议**" "$COMPACT_FILE" || { echo "错误：'$COMPACT_FILE' 文件格式不完整，缺少“后续行动协议”章节。" >&2; exit 1; }

# 如果所有检查都通过，则成功退出
exit 0
```

**【第二步：上下文加载 (Context Loading)】**

在步骤一验证成功后，你**必须**遵循以下严格的流程来加载上下文：

1.  **读取协议文件**: 使用 `Read` 工具，读取 `.compact_args.md` 文件的**全部内容**。
2.  **解析与执行恢复协议**:
    -   在你的内部逻辑中，仔细解析该文件的 **"3. 下一轮对话记忆恢复协议"** 章节。
    -   你**必须**提取出该章节中列出的**所有**文件和目录的路径。
    -   你**必须**严格遵循核心配置文件（`CLAUDE.md`）中定义的 **`流式批量读取协议`**，为所有提取出的路径，逐一地、无回复地生成并执行一系列的 `Read` 和 `Glob` 工具调用，以将所有必要的文件内容完整地加载到你的上下文中。
    -   对于使用 `Search` 搜索到的文件路径，你**必须**阅读这些文件的内容。
    -   你无需创建TODOS；调用任何工具时，都要逐一调用，保持静默，不回复用户；严格遵守各级别提示词的要求、承诺、用词规范、系统思维和编程哲学。
**【第三步：状态总结与授权请求 (Status Summary & Authorization Request)】**

这是你的**最终行动**。在完成所有文件的读取后：

1.  **解析核心信息**: 在你的内部逻辑中，解析 `.compact_args.md` 文件中的 **"1. 核心任务与当前状态"** 和 **"5. 后续行动协议"**。
2.  **生成总结陈述**: 你**必须**根据解析出的信息，向用户输出一段严格遵循以下格式的总结陈述。
3.  **强制等待**: 在输出总结陈述后，你的任务即告完成。你**必须**立即停止所有主动行为，并将控制权交还给用户，以等待用户的下一步确认指令。

**总结陈述模板**:
> 上下文已成功恢复。
>
> -   **核心任务**: [此处插入核心任务]
> -   **当前状态**: [此处插入当前状态]
> -   **下一步行动**: [此处插入后续行动协议中定义的下一步任务]
>
> 请确认是否继续？

---
